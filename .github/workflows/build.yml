name: Build

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    name: Build Debug
    runs-on: ubuntu-latest
    env:
      SIGNING_KEY_STORE_BASE64: ${{ secrets.SIGNING_KEY_STORE_BASE64 }}
      SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
      SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
      SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
      GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
      APP_BASE_URL: ${{ vars.APP_BASE_URL || secrets.APP_BASE_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Decode Google Services (FCM)
        if: env.GOOGLE_SERVICES_JSON_BASE64 != ''
        run: |
          echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 --decode > app/google-services.json

      - name: Override App Base URL
        if: env.APP_BASE_URL != ''
        run: |
           sed -i 's|<string name="app_base_url" translatable="false">.*</string>|<string name="app_base_url" translatable="false">'"$APP_BASE_URL"'</string>|' app/src/main/res/values/values.xml

      - name: Build Play Release
        run: ./gradlew assemblePlayRelease

      - name: Build F-Droid Release
        run: ./gradlew assembleFdroidRelease

      - name: Sign APKs (Release Key)
        if: env.SIGNING_KEY_STORE_BASE64 != ''
        id: sign_app_release
        run: |
          echo "$SIGNING_KEY_STORE_BASE64" | base64 --decode > release.jks
          
          BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools | sort -r | head -n 1)
          echo "Using Build Tools: $BUILD_TOOLS_VERSION"
          ZIPALIGN=$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/zipalign
          APKSIGNER=$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner

          # Process Play release
          for apk in app/build/outputs/apk/play/release/*.apk; do
             echo "Processing $apk..."
             aligned_apk="${apk%.*}-aligned.apk"
             "$ZIPALIGN" -v -p 4 "$apk" "$aligned_apk"
             
             echo "Signing $aligned_apk..."
             "$APKSIGNER" sign --ks release.jks --ks-key-alias "$SIGNING_KEY_ALIAS" --ks-pass "pass:$SIGNING_STORE_PASSWORD" --key-pass "pass:$SIGNING_KEY_PASSWORD" "$aligned_apk"
          done
          rm release.jks

      - name: Sign F-Droid/Other APKs (Release Key)
        if: env.SIGNING_KEY_STORE_BASE64 != ''
        run: |
            echo "$SIGNING_KEY_STORE_BASE64" | base64 --decode > release.jks
            BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools | sort -r | head -n 1)
            APKSIGNER=$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner

            # Sign F-Droid release
            for apk in app/build/outputs/apk/fdroid/release/*.apk; do
               echo "Processing $apk..."
               aligned_apk="${apk%.*}-aligned.apk"
               "$ZIPALIGN" -v -p 4 "$apk" "$aligned_apk"
               
               echo "Signing $aligned_apk..."
               "$APKSIGNER" sign --ks release.jks --ks-key-alias "$SIGNING_KEY_ALIAS" --ks-pass "pass:$SIGNING_STORE_PASSWORD" --key-pass "pass:$SIGNING_KEY_PASSWORD" "$aligned_apk"
            done
            rm release.jks

      - name: Sign APKs (Debug Key)
        if: env.SIGNING_KEY_STORE_BASE64 == ''
        run: |
          # Fallback for PRs from forks or missing secrets
          keytool -genkey -v -keystore debug.keystore -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US"
          
          BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools | sort -r | head -n 1)
          APKSIGNER=$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner
          
          for apk in app/build/outputs/apk/*/release/*.apk; do
            echo "Processing $apk..."
            aligned_apk="${apk%.*}-aligned.apk"
            # Some APKs might already be aligned if created by valid previous steps? No, glob includes unaligned.
            # But wait, our release signing steps created *-aligned.apk.
            # This debug step only runs if secrets are missing (fallback). So release steps didn't run.
            # But the glob will pick up only the unsigned ones.
            
            "$ZIPALIGN" -v -p 4 "$apk" "$aligned_apk"
            
            echo "Signing $aligned_apk with debug key..."
            "$APKSIGNER" sign --ks debug.keystore --ks-key-alias androiddebugkey --ks-pass pass:android --key-pass pass:android "$aligned_apk"
          done

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: |
            app/build/outputs/apk/play/release/*.apk
            app/build/outputs/apk/fdroid/release/*.apk
